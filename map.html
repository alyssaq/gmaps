<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link href="/css/map.css" rel="stylesheet">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <title>Gmaps fun - Alyssa Quek</title>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>
    <script>
function initialize() {
  var leftPos = google.maps.ControlPosition.LEFT_CENTER,
    map = new google.maps.Map(document.getElementById('map-canvas'), {
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    panControlOptions:   { position: leftPos },
    zoomControlOptions:  { position: leftPos },
    scaleControlOptions: { position: leftPos }
  });
  var directionsDisplay = new google.maps.DirectionsRenderer();
  var directionsService = new google.maps.DirectionsService();

  map.fitBounds(new google.maps.LatLngBounds(
    new google.maps.LatLng(1.300395,103.629227),
    new google.maps.LatLng(1.445922,103.977646)
  ));
  directionsDisplay.setMap(map);

  var infowindow = new google.maps.InfoWindow(),
    marker = new google.maps.Marker({ map: map }),
    isValid = {origin: false, destination: false},
    addresses = {origin: '', destination: ''};

  var findAddress = function(gmapAutocomplete, oriDest) {
    //resets when a new place is selected
    infowindow.close();
    marker.setVisible(false);

    var place = gmapAutocomplete.getPlace(),
      addr = '';
    if (!place.geometry) {
      document.getElementById("box").innerHTML = oriDest + " location not found";
      return;
    }

    if (place.address_components) {
      addr = [
        (place.address_components[0] && place.address_components[0].short_name || ''),
        (place.address_components[1] && place.address_components[1].short_name || ''),
        (place.address_components[2] && place.address_components[2].short_name || '')
      ].join(' ');
      isValid[oriDest]   = true;
      addresses[oriDest] = (place.name + "," + addr);
    }

    if (isValid['origin'] && isValid['destination']) {
      calcRoute();
    } else {
      //If place has a geometry and route and yet plottable, then present it on the map
      if (place.geometry.viewport) {
        map.fitBounds(place.geometry.viewport);
      } else {
        console.log('geometry is not within viewport');
        map.setCenter(place.geometry.location);
        map.setZoom(17);
      }

      marker.setPosition(place.geometry.location);
      marker.setVisible(true);

      infowindow.setContent('<div><strong>' + place.name + '</strong><br>' + addr);
      infowindow.open(map, marker);
    }
  }

  var autocompleteAndFindPlace = function(oriDest) {
    var input = (document.getElementById(oriDest));
    var autocomplete = new google.maps.places.Autocomplete(input, 
      { componentRestrictions: {country: 'sg'} }
    );
    autocomplete.bindTo('bounds', map);
    google.maps.event.addListener(autocomplete, 'place_changed', function() {
      findAddress(autocomplete, oriDest);
    })
  }

  autocompleteAndFindPlace('origin');
  autocompleteAndFindPlace('destination');

  function calcRoute() {
    var request = {
        origin:      addresses['origin'],
        destination: addresses['destination'],
        travelMode:  google.maps.DirectionsTravelMode.WALKING
    };
    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
        document.getElementById("box").innerHTML = "Approx walking distance: " + response.routes[0].legs[0].distance.text
                                                  + ", duration: " + response.routes[0].legs[0].duration.text;
      } else {
        document.getElementById("box").innerHTML = "Could not plot route. Please try different locations";
      }
    });
  }
}

google.maps.visualRefresh = true;
google.maps.event.addDomListener(window, 'load', initialize);

  </script>
  </head>
  <body>
    <div class="top">
      <div class="row">
        <div class="col-6"><input id="origin" type="text" class="form-control" placeholder="From location"></div>
        <div class="col-6"><input id="destination" type="text" class="form-control" placeholder="To location"></div>
      </div>
      <p id="box" class="text-center"></p>
    </div>
    <div id="map-canvas"></div>
  </body>
</html>